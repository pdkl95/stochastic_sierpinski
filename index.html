<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Stochastic Sierpinski</title>
    <style type="text/css" media="screen">
* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
* html {
  font-size: 75%;
}

html {
  font-size: 100%;
  line-height: 16px;
  overflow-y: scroll;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  font-family: Ubuntu, sans-serif;
  font-family: Ubuntu, sans-serif;
  font-weight: 400;
  font-style: normal;
  text-transform: none;
  text-decoration: none;
  letter-spacing: 0em;
  word-spacing: 0em;
}

body {
  margin: 0.1rem 1rem;
  font-size: 12px;
  line-height: 16px;
}

pre, code, kbd, tt, select, input, textarea {
  font-family: "Ubuntu Mono", Inconsolata, Consolas, monospace;
  font-size: 13px;
}

pre {
  background-color: #eee;
  padding: 2px 5px;
  box-shadow: 1px 1px 4px -3px rgba(0, 0, 0, 0.4) inset;
  border: 1px inset rgba(200, 200, 200, 0.4);
  border-radius: 8px;
}

code {
  display: inline-block;
  background-color: #ececec;
  box-shadow: 0px 1px 7px 1px #fff inset;
  border-radius: 8px;
  margin: 0px -3px;
}

pre code {
  border-bottom: none;
  box-shadow: none;
  background: transparent;
  line-height: 16px;
  padding: 0px 3px;
}

h1 {
  color: #111;
  margin-bottom: 0.6rem;
  margin-left: -0.1rem;
  margin-top: 2.5rem;
  padding: 5px 0.5rem;
  background-color: #f2f2f2;
  border: 1px outset rgba(0, 0, 0, 0.3);
  box-shadow: 1px 1px 6px -3px rgba(0, 0, 0, 0.22), 0 0 20px -4px rgba(255, 255, 255, 0.45) inset;
  border-radius: 5px 5px 5px 5px;
}
h1:first-top {
  margin-top: 0.5rem;
}
h1 + pre, h1 + p {
  margin-top: 1rem;
}
h1 + h2 {
  margin-top: 0.4rem;
}

h2 {
  margin-top: 1.6rem;
  margin-bottom: 0.5rem;
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  padding-bottom: 1px;
}
h2 > code {
  background: transparent;
  box-shadow: none;
}

h3 {
  margin-top: 1.6rem;
  margin-bottom: 0.5rem;
  margin-top: 0.6rem;
  margin-left: 2rem;
  margin-bottom: 0.2rem;
}
h3 > code {
  background: transparent;
  box-shadow: none;
}

h4, h5, h6 {
  margin-left: 2rem;
}

h5 {
  padding-left: 0.2em;
  margin-bottom: 0;
}

h3 {
  margin-top: 1.5rem;
  margin-bottom: 1.4rem;
  padding: 0;
  margin-bottom: 0;
}

h4, h6 {
  padding: 0;
  margin-bottom: 0;
}

p, pre, table {
  margin-left: 2rem;
  margin-right: 2rem;
  margin-top: 0;
  margin-bottom: 1rem;
}

h5 {
  padding-left: 5px;
}

ol, ul {
  list-style-position: inside;
  margin-left: 0;
  padding-left: 2rem;
}

li {
  padding-left: 0;
}
li > p {
  display: inline;
  margin: 0;
  padding: 0;
}

a {
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}

li > h2 {
  margin: 0;
}

p {
  color: #444;
}

.hidden {
  display: none;
}

body > footer {
  margin-top: 8em;
}


    </style>
    <style type="text/css" media="screen" title="app_stylesheet">
body {
  background: #bbb;
}

h1 {
  margin-top: 1.5rem;
  padding-top: 7px;
  padding-bottom: 7px;
}

.panel {
  border: 1px outset rgba(0, 0, 0, 0.3);
  border-radius: 4px;
  background-color: #F2F2F2;
  padding: 4px;
}

#content > .graph.panel {
}

.graph_canvas {
  position: absolute;
  top: 0;
  left: 0;
}

.canvas_size {
  width: 420px;
  height: 320px;
}

.canvas_wrapper {
  background-color: #fff;
  border-radius: 3px;
  border: 1px inset rgba(0, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
}

.resizable {
  resize: both;
}

.panel {
  box-shadow: 1px 1px 6px -3px rgba(0, 0, 0, 0.22), 0 0 20px -4px rgba(255, 255, 255, 0.45) inset;
}

.graph.panel {
  float: left;
  margin-right: 7px;
  padding: 4px;
}

.info.panel {
  float: left;

}

.graph.panel,
.info.panel {
  margin-bottom: 7px;
}

.ui.panel {
  clear: both;
}

footer {
  clear: both;
}

.panel tr > th:first-child {
  text-align: right;
  padding-right: 0.4em;
}


.ui.panel > .buttonbox {
  display: inline-block;
}

.buttonbox > .title {
  display: inline-block;
  margin-left: 1em;
  margin-right: 0.333em;
}

.buttonbox > .title:first-child {
  font-weight: bold;
  margin-left: 0em;
  margin-right: 1em;
}

.buttonbox.pointsbox {
  float: right;
}

.buttonbox.pointsbox ~ hr {
  clear: both;
  margin-top: 4px;
  margin-bottom: 4px;
  opacity: 0.18;
}

.ui.panel > hr ~ h3 {
  margin-top: 0.5rem;
}

.restrictbox {
  overflow-x: auto;
}

#restrict_table {
  border-spacing: 0;
}

#restrict_table th,
#restrict_table td {
  padding: 3px;
  text-align: center;
}

#restrict_table th[scope="row"] {
  text-align: right;
}

#restrict_table .self,
#restrict_table .opposite {
  background-color: #e2e2e2
}

td.blank {
  border: none;
}

#button_run {
  min-width: 4.5em;
}

#num_points {
  width: 3em;
}

#canvas_width,
#canvas_height {
  width: 5em;
}

#steps_per_frame,
#draw_opacity {
  width: 3.5em;
}

#point_pos_table input[type="range"] {
  width: 10em;
}

#point_pos_table td:nth-child(3),
#point_pos_table td:nth-child(4),
#point_pos_table td:nth-child(5) {
  text-align: right;
}

.highlight > td {
  background-color: #F9FBB6;
}

.highlight > td:first-child {
  font-weight: bold;
}

#serializebox {
  display: none;
  position: fixed;
  top: 6em;
  left: 4em;
  border-radius: 8px;
  border: 2px outset rgba(0, 0, 0, 0.5);
  padding: 1em;
  min-width: 50%;
  background: #ddd;
}

#serializebox_title {
  margin-top: 0;
  margin-left: 0;
  margin-bottom: 0.666em;
}

#serializebox_text {
  width: 100%;
  min-height: 8em;
}

#serializebox > .ui.panel {
  text-align: right;
}

    </style>
  </head>
  <body>
    <header>
      <h1>Stochastic Sierpinski</h1>
    </header>

    <div id="content">
      <div class="graph panel">
        <div id="graph_wrapper" class="canvas_wrapper canvas_size">
          <canvas id="graph" class="graph_canvas canvas_size" width="420" height="320">
            This requires a browser that supports the &lt;canvas&gt; tag.
          </canvas>
          <canvas id="graph_ui" class="graph_canvas canvas_size" width="420" height="320">
            This requires a browser that supports the &lt;canvas&gt; tag.
          </canvas>
        </div>
      </div>

      <div class="info panel">
        <table id="misc_info_table">
          <tr>
            <th>Current Location</th>
            <td id="point_cur_x"></td>
            <td id="point_cur_y"></td>
          </tr>
          <tr>
            <th>Total Steps</th>
            <td id="total_steps" colspan=2></td>
          </tr>
          <tr>
            <th>Steps / Frame</th>
            <td colspan=2>
              <input type="number" id="steps_per_frame"
                     min="0" max="500" step="10">
            </td>
          </tr>
        </table>
        <table id="point_pos_table">
          <tr>
            <th>P</th>
            <th>Color</th>
            <th>X</th>
            <th>Y</th>
            <th>Move %</th>
            <th></th>
          </tr>
        </table>
      </div>

      <div class="ui panel">
        <div class="runbox buttonbox">
          <button id="button_reset">Reset</button>
          <button id="button_step">Step 1x</button>
          <button id="button_multistep">Step Nx</button>
          <button id="button_run">Run</button>
        </div>

        <div class="pointsbox buttonbox">
          <span class="title">Points</span>
          <label for="num_points">N =</label>
          <input type="number" id="num_points" value="3"
                 min="3" max="8" step="1">
          <span class="title">Move All</span>
          <button id="move_all_reg_polygon">Reg. Polygon</button>
          <button id="move_all_random">Random</button>
        </div>

        <hr>

        <h3>Restrictions</h3>

        <div class="restrictbox buttonbox">
          <table id="restrict_table">
            <tr>
              <td class="blank"></td>
              <th scope="col" class="header prev prev3">-3</th>
              <th scope="col" class="header prev prev2">-2</th>
              <th scope="col" class="header prev prev1">-1</th>
              <th scope="col" class="header self">Self</th>
              <th scope="col" class="header next next1">+1</th>
              <th scope="col" class="header next next2">+2</th>
              <th scope="col" class="header next next3">+3</th>
              <th scope="col" class="header opposite">Opp</th>
            </tr>
            <tr>
              <th scope="row">Last</th>
              <td class="single prev prev3"><input type="checkbox" id="restrict_single_prev_3"></td>
              <td class="single prev prev2"><input type="checkbox" id="restrict_single_prev_2"></td>
              <td class="single prev prev1"><input type="checkbox" id="restrict_single_prev_1"></td>
              <td class="single self">      <input type="checkbox" id="restrict_single_self"></td>
              <td class="single next next1"><input type="checkbox" id="restrict_single_next_1"></td>
              <td class="single next next2"><input type="checkbox" id="restrict_single_next_2"></td>
              <td class="single next next3"><input type="checkbox" id="restrict_single_next_3"></td>
              <td class="single opposite">  <input type="checkbox" id="restrict_single_opposite"></td>
            </tr>
            <tr>
              <th scope="row" class="double">Last 2x</th> 
              <td class="double prev prev3"><input type="checkbox" id="restrict_double_prev_3"></td>
              <td class="double prev prev2"><input type="checkbox" id="restrict_double_prev_2"></td>
              <td class="double prev prev1"><input type="checkbox" id="restrict_double_prev_1"></td>
              <td class="double self">      <input type="checkbox" id="restrict_double_self"></td>
              <td class="double next next1"><input type="checkbox" id="restrict_double_next_1"></td>
              <td class="double next next2"><input type="checkbox" id="restrict_double_next_2"></td>
              <td class="double next next3"><input type="checkbox" id="restrict_double_next_3"></td>
              <td class="double opposite">  <input type="checkbox" id="restrict_double_opposite"></td>
            </tr>
          </table>
        </div>

        <h3>Other Options</h3>

        <div class="optionsbox buttonbox">
          <table>
            <tr>
              <th>Canvas Size</th>
              <td>
                <input id="canvas_width" type="number" value="420"
                       min="64" max="4096" step="1">
                &nbsp;x&nbsp;
                <input id="canvas_height" type="number" value="320"
                       min="64" max="4096" step="1">
              </td>
            </tr>
            <tr>
              <th>Draw Style</th>
              <td>
                <select id="draw_style" name="draw_style">
                  <option value="mono">Monochrome (black on white)</option>
                  <option value="color_target">Color = target</option>
                  <option value="color_blend_prev_target">Color = blend(target, previous_target)</option>
                  <option value="color_blend_prev_color">Color = blend(target, previous_blended_color)</option>
                </select>
              </td>
            </tr>
            <tr>
              <th>Draw Opacity</th>
              <td><input id="draw_opacity" type="number"
                         min="0" max="100" step="5"></td>
            </tr>
          </table>
        </div>

        <hr>

        <div class="imgbox buttonbox">
          <button id="button_create_png">Create PNG</button>
          <button id="button_save_url">Save as URL</button>
          <button id="button_save">Save as JSON</button>
          <button id="button_load">Load from JSON</button>
        </div>
      </div>

      <div id="serializebox">
        <h3 id="serializebox_title" class="panel">Title</h3>
        <textarea id="serializebox_text"></textarea>
        <div class="ui panel">
          <div class="actionbuttons buttonbox">
            <button id="serializebox_action">Unknown Action</button>
            <button id="serializebox_cancel">Cancel</button>          
          </div>
        </div>
      </div>
    </div>

    <footer></footer>

    <script type="text/javascript">
(function() {
  var APP, BoolOtherOption, Color, DrawPoint, EnumOtherOption, NumberOtherOption, OtherOption, Point, PointWidget, StochasticSierpinski, TargetRestriction, TargetRestrictionOption, UIPoint, base,
    slice = [].slice,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  APP = null;

  if ((base = Array.prototype).flatten == null) {
    base.flatten = function() {
      var el, j, len1, ref, result;
      result = [];
      ref = this;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        el = ref[j];
        if (el instanceof Array) {
          result = result.concat(el.flatten());
        } else {
          result.push(el);
        }
      }
      return result;
    };
  }

  if (Math.TAU == null) {
    Math.TAU = 2 * Math.PI;
  }

  if (Object.values == null) {
    Object.values = function(obj) {
      return Object.keys(obj).map(function(x) {
        return obj[x];
      });
    };
  }

  Color = (function() {
    function Color() {}

    Color.hsl_to_rgb = function(h, s, l) {
      var m1, m2;
      m2 = l <= 0.5 ? l * (s + 1) : l + s - (l * s);
      m1 = (l * 2) - m2;
      return [Color.hue_to_rgb(m1, m2, h + (1 / 3)), Color.hue_to_rgb(m1, m2, h), Color.hue_to_rgb(m1, m2, h - (1 / 3))];
    };

    Color.hue_to_rgb = function(m1, m2, h) {
      if (h < 0) {
        h = h + 1;
      }
      if (h > 1) {
        h = h - 1;
      }
      if (h * 6 < 1) {
        return m1 + ((m2 - m1) * h * 6);
      }
      if (h * 2 < 1) {
        return m2;
      }
      if (h * 3 < 2) {
        return m1 + ((m2 - m1) * ((2 / 3) - h) * 6);
      }
      return m1;
    };

    Color.component_to_hex = function(x) {
      var str;
      str = Math.round(x * 255).toString(16);
      if (str.length === 1) {
        return '0' + str;
      } else {
        return str;
      }
    };

    Color.hsl_to_hexrgb = function() {
      var args, hex;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      hex = Color.hsl_to_rgb.apply(Color, args).map(Color.component_to_hex);
      return "#" + (hex.join(''));
    };

    Color.hexrgb_to_rgb = function(hexrgb) {
      var md;
      md = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hexrgb);
      if (md) {
        return [parseInt(md[1], 16), parseInt(md[2], 16), parseInt(md[3], 16)];
      } else {
        return [0, 0, 0];
      }
    };

    Color.hexrgb_and_alpha_to_rgba_str = function(hexrgb, alpha) {
      var rgb;
      rgb = Color.hexrgb_to_rgb(hexrgb);
      return "rgba(" + rgb[0] + "," + rgb[1] + "," + rgb[2] + "," + alpha + ")";
    };

    Color.rgb_to_hsl = function(rgb) {
      var b, cmax, cmin, delta, g, h, l, r, s;
      r = rgb[0] / 255;
      g = rgb[2] / 255;
      b = rgb[2] / 255;
      cmin = Math.min(r, g, b);
      cmax = Math.max(r, g, b);
      delta = cmax - cmin;
      h = delta === 0 ? 0 : cmax === r ? ((g - b) / delta) % 6 : cmax === g ? (b - r) / delta + 2 : (r - g) / delta + 4;
      h = Math.round(h * 60);
      if (h < 0) {
        h += 360;
      }
      l = (cmax + cmin) / 2;
      s = delta === 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
      s = +(s * 100).toFixed(1);
      l = +(l * 100).toFixed(1);
      return [h, s, l];
    };

    Color.blend_rgb = function() {
      var args, len, total;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      total = args.reduce(function(acc, cur) {
        acc[0] += cur[0];
        acc[1] += cur[1];
        acc[2] += cur[2];
        return acc;
      });
      len = args.length;
      return [Math.floor(total[0] / len), Math.floor(total[1] / len), Math.floor(total[2] / len)];
    };

    Color.blend_hsl = function(a_hsl, b_hsl) {
      var ah, bh, h, hdelta;
      ah = a_hsl[0];
      bh = b_hsl[0];
      if (bh < ah) {
        bh += 360;
      }
      hdelta = bh - ah;
      h = ah + (hdelta / 2);
      if (h >= 360) {
        h -= 360;
      }
      return [h, Math.floor((a_hsl[1] + b_hsl[1]) / 2), Math.floor((a_hsl[2] + b_hsl[2]) / 2)];
    };

    Color.blend_hsl_from_rgb = function(a_rgb, b_rgb) {
      var a_hsl, b_hsl;
      a_hsl = Color.rgb_to_hsl(a_rgb);
      b_hsl = Color.rgb_to_hsl(b_rgb);
      return this.blend_hsl(a_hsl, b_hsl);
    };

    return Color;

  })();

  Point = (function() {
    function Point(name1, x, y, move_perc) {
      this.name = name1;
      this.move_perc = move_perc != null ? move_perc : 0.5;
      if (x == null) {
        x = APP.graph_ui_canvas.width / 2;
      }
      if (y == null) {
        y = APP.graph_ui_canvas.height / 2;
      }
      this.el_id = this.name.toLowerCase();
      this.info_x_id = 'point_' + this.el_id + '_x';
      this.info_y_id = 'point_' + this.el_id + '_y';
      this.move(x, y);
    }

    Point.prototype.update_text = function() {
      if (this.info_x) {
        this.info_x.textContent = this.ix;
      }
      if (this.info_y) {
        return this.info_y.textContent = this.iy;
      }
    };

    Point.prototype.move_no_text_update = function(x, y) {
      this.x = x;
      this.y = y;
      this.ix = Math.floor(this.x);
      return this.iy = Math.floor(this.y);
    };

    Point.prototype.move = function(x, y) {
      this.move_no_text_update(x, y);
      return this.update_text();
    };

    Point.prototype.move_towards = function(other, perc) {
      var dx, dy;
      if (perc == null) {
        perc = other.move_perc;
      }
      dx = other.x - this.x;
      dy = other.y - this.y;
      return this.move(this.x + dx * perc, this.y + dy * perc);
    };

    Point.prototype.move_towards_no_text_update = function(other, perc) {
      var dx, dy;
      if (perc == null) {
        perc = other.move_perc;
      }
      dx = other.x - this.x;
      dy = other.y - this.y;
      return this.move_no_text_update(this.x + dx * perc, this.y + dy * perc);
    };

    Point.prototype.distance = function(other) {
      var dx, dy;
      dx = this.x - other.x;
      dy = this.y - other.y;
      return Math.sqrt((dx * dx) + (dy * dy));
    };

    return Point;

  })();

  UIPoint = (function(superClass) {
    extend(UIPoint, superClass);

    function UIPoint() {
      var args, hue;
      hue = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      this.set_color_hue(hue);
      UIPoint.__super__.constructor.apply(this, args);
    }

    UIPoint.prototype.update_color_alpha_from_color = function() {
      return this.set_opacity(APP.option.draw_opacity.value);
    };

    UIPoint.prototype.set_color_hue = function(hue) {
      return this.set_color(Color.hsl_to_hexrgb(hue / 360, 1.0, 0.5));
    };

    UIPoint.prototype.set_color = function(color) {
      var ref;
      this.color = color;
      this.update_color_alpha_from_color();
      return (ref = APP.cur) != null ? ref.reset_color_cache() : void 0;
    };

    UIPoint.prototype.set_alpha = function(alpha) {
      return this.color_alpha = Color.hexrgb_and_alpha_to_rgba_str(this.color, alpha);
    };

    UIPoint.prototype.set_opacity = function(opacity) {
      return this.set_alpha(opacity / 100);
    };

    UIPoint.prototype.draw_ui = function() {
      var ctx;
      ctx = APP.graph_ui_ctx;
      ctx.strokeStyle = this.color;
      return ctx.strokeRect(this.x - 2, this.y - 2, 5, 5);
    };

    return UIPoint;

  })(Point);

  PointWidget = (function(superClass) {
    extend(PointWidget, superClass);

    PointWidget.widgets = [];

    PointWidget.MIN_POINTS = 3;

    PointWidget.MAX_POINTS = 8;

    PointWidget.NEARBY_RADIUS = 8;

    PointWidget.REG_POLYGON_MARGIN = 10;

    PointWidget.restrictions = null;

    PointWidget.restricted = {
      single: [],
      double: []
    };

    PointWidget.prev_target = [null, null, null];

    PointWidget.target_chosen_twice = function() {
      return this.prev_target[0] === this.prev_target[1];
    };

    PointWidget.current_restricted_choices = function() {
      if (this.restrictions.using_double() && this.target_chosen_twice()) {
        return this.restricted.double;
      } else {
        return this.restricted.single;
      }
    };

    PointWidget.filtered_choices = function(type) {
      var choices, last, len, n, neighbor, p, ref, value_getter;
      value_getter = "value_" + type;
      len = this.widgets.length;
      last = len - 1;
      choices = [];
      if (!this.restrictions.option.self[value_getter]) {
        choices.push(0);
      }
      len -= 1;
      if (len % 2 === 1) {
        len -= 1;
        if (!this.restrictions.option.opposite[value_getter]) {
          choices.push(parseInt(last / 2) + 1);
        }
      }
      neighbor = 1;
      while (len >= 2) {
        ref = this.restrictions.neighbor(neighbor), p = ref[0], n = ref[1];
        if (!p[value_getter]) {
          choices.push(p.offset + this.widgets.length);
        }
        if (!n[value_getter]) {
          choices.push(n.offset);
        }
        len -= 2;
        neighbor += 1;
      }
      return choices;
    };

    PointWidget.update_widget_list_metadata = function() {
      if (this.widgets.length < 3) {
        return;
      }
      this.restrictions.set_enabled(this.widgets.length);
      this.restricted.single = this.filtered_choices('single');
      this.restricted.double = this.filtered_choices('double');
      return this.prev_target[0] = this.prev_target[1] = this.widgets[0];
    };

    PointWidget.add_widget = function() {
      if (PointWidget.widgets.length < this.MAX_POINTS) {
        PointWidget.create();
        return APP.resumable_reset();
      }
    };

    PointWidget.remove_widget = function() {
      var len;
      len = PointWidget.widgets.length;
      if (len > this.MIN_POINTS) {
        return PointWidget.widgets[len - 1].destroy();
      }
    };

    PointWidget.recolor_periodic_hue = function(step, start) {
      var hue, j, len1, ref, results, w;
      if (start == null) {
        start = 0.0;
      }
      hue = start;
      ref = PointWidget.widgets;
      results = [];
      for (j = 0, len1 = ref.length; j < len1; j++) {
        w = ref[j];
        w.set_color_hue(hue);
        results.push(hue += step);
      }
      return results;
    };

    PointWidget.recolor_equidistant_hue = function() {
      return PointWidget.recolor_periodic_hue(360.0 / PointWidget.widgets.length);
    };

    PointWidget.set_ngon = function(n, recolor) {
      if (recolor == null) {
        recolor = true;
      }
      PointWidget.set_num_widgets(n);
      PointWidget.move_all_reg_polygon();
      if (recolor) {
        return PointWidget.recolor_equidistant_hue();
      }
    };

    PointWidget.set_num_widgets = function(n) {
      var results;
      if (!(n >= this.MIN_POINTS && n <= this.MAX_POINTS)) {
        return;
      }
      while (n > PointWidget.widgets.length) {
        PointWidget.add_widget();
      }
      results = [];
      while (PointWidget.widgets.length > n) {
        results.push(PointWidget.remove_widget());
      }
      return results;
    };

    PointWidget.move_all_reg_polygon = function() {
      var cx, cy, height, i, j, len, len1, maxx, maxy, minside, r, ref, ref1, rotate, side, theta, tri_adj, w, x, y;
      len = PointWidget.widgets.length;
      ref = APP.max_xy(), maxx = ref[0], maxy = ref[1];
      minside = Math.min(maxx, maxy);
      cx = maxx / 2;
      cy = maxy / 2;
      r = Math.min(cx, cy) - this.REG_POLYGON_MARGIN;
      theta = (Math.PI * 2) / len;
      rotate = -Math.PI / 2;
      switch (len) {
        case 3:
          side = minside - (2 * this.REG_POLYGON_MARGIN);
          height = side * (Math.sqrt(3) / 2);
          tri_adj = (minside - height) / 2;
          cy += tri_adj * Math.sqrt(2);
          r *= 1.2;
          break;
        case 4:
          rotate += Math.PI / 4;
          r *= Math.sqrt(2);
      }
      ref1 = PointWidget.widgets;
      for (i = j = 0, len1 = ref1.length; j < len1; i = ++j) {
        w = ref1[i];
        x = parseInt(r * Math.cos(rotate + theta * i));
        y = parseInt(r * Math.sin(rotate + theta * i));
        w.move(cx + x, cy + y);
      }
      return APP.resumable_reset();
    };

    PointWidget.move_all_random = function() {
      var j, len1, ref, w;
      ref = PointWidget.widgets;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        w = ref[j];
        w.move(APP.random_x(), APP.random_y());
      }
      return APP.resumable_reset();
    };

    PointWidget.clamp_widgets_to_canvas = function() {
      var height, j, len1, ref, ref1, results, w, width;
      ref = APP.max_xy(), width = ref[0], height = ref[1];
      ref1 = PointWidget.widgets;
      results = [];
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        w = ref1[j];
        if (w.x < 0) {
          w.x = 0;
        }
        if (w.y < 0) {
          w.y = 0;
        }
        if (w.x >= width) {
          w.x = width - 1;
        }
        if (w.y >= height) {
          results.push(w.y = height - 1);
        } else {
          results.push(void 0);
        }
      }
      return results;
    };

    PointWidget.nearby_widgets = function(loc) {
      return this.widgets.filter((function(_this) {
        return function(w) {
          return w.distance(loc) < _this.NEARBY_RADIUS;
        };
      })(this));
    };

    PointWidget.first_nearby_widget = function(loc) {
      var nearlist;
      nearlist = PointWidget.nearby_widgets(loc);
      if (nearlist != null) {
        return nearlist[0];
      } else {
        return null;
      }
    };

    PointWidget.random_widget = function() {
      var choice, choices, idx, prev_idx, w;
      choices = this.current_restricted_choices();
      choice = choices[parseInt(Math.random() * choices.length)];
      prev_idx = PointWidget.widgets.indexOf(this.prev_target[0]);
      idx = (choice + prev_idx) % PointWidget.widgets.length;
      w = PointWidget.widgets[idx];
      this.prev_target[2] = this.prev_target[1];
      this.prev_target[1] = this.prev_target[0];
      this.prev_target[0] = w;
      return w;
    };

    PointWidget.unhighlight_all = function() {
      var changed, j, len1, ref, w;
      changed = false;
      ref = this.widgets;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        w = ref[j];
        if (w.unhighlight()) {
          changed = true;
        }
      }
      return changed;
    };

    PointWidget.is_name_used = function(name) {
      var j, len1, ref, w;
      ref = PointWidget.widgets;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        w = ref[j];
        if (w.name === name) {
          return true;
        }
      }
      return false;
    };

    PointWidget.next_name = function() {
      var code, j, str;
      for (code = j = 65; j <= 90; code = ++j) {
        str = String.fromCharCode(code);
        if (!PointWidget.is_name_used(str)) {
          return str;
        }
      }
      alert('sorry, cannot generate more than 26 point names');
      throw 'cannot generate a unique point name';
    };

    PointWidget.create = function(opt) {
      var w;
      if (opt == null) {
        opt = {};
      }
      if (opt.name == null) {
        opt.name = PointWidget.next_name();
      }
      if (opt.hue == null) {
        opt.hue = Math.random() * 360;
      }
      if (opt.move_perc == null) {
        opt.move_perc = 0.5;
      }
      if (opt.x == null) {
        opt.x = APP.random_x();
      }
      if (opt.y == null) {
        opt.y = APP.random_y();
      }
      return w = new PointWidget(opt.hue, opt.name, opt.x, opt.y, opt.move_perc);
    };

    function PointWidget() {
      var args;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      this.on_move_per_range_input = bind(this.on_move_per_range_input, this);
      this.on_color_change = bind(this.on_color_change, this);
      PointWidget.__super__.constructor.apply(this, args);
      this.build();
      PointWidget.widgets.push(this);
      PointWidget.update_widget_list_metadata();
    }

    PointWidget.prototype.build = function() {
      var color_selector, move_perc_adj_cell;
      this.draw_highlight = false;
      this.row = APP.point_pos_table.insertRow(-1);
      this.namecell = this.row.insertCell(0);
      this.set_name(this.name);
      this.color_selector_el = document.createElement('input');
      this.color_selector_el.type = 'color';
      this.color_selector_el.value = this.color;
      this.color_selector_el.addEventListener('change', this.on_color_change);
      color_selector = this.row.insertCell(1);
      color_selector.appendChild(this.color_selector_el);
      this.info_x = this.row.insertCell(2);
      this.info_x.textContent = this.x;
      this.info_y = this.row.insertCell(3);
      this.info_y.textContent = this.y;
      this.move_perc_cell = this.row.insertCell(4);
      this.move_perc_cell.textContent = this.move_perc.toFixed(2);
      this.move_per_range_el = document.createElement('input');
      this.move_per_range_el.type = 'range';
      this.move_per_range_el.min = 0;
      this.move_per_range_el.max = 1;
      this.move_per_range_el.step = 0.05;
      this.move_per_range_el.value = this.move_perc;
      this.move_per_range_el.addEventListener('input', this.on_move_per_range_input);
      move_perc_adj_cell = this.row.insertCell(5);
      return move_perc_adj_cell.appendChild(this.move_per_range_el);
    };

    PointWidget.prototype.set_name = function(name) {
      this.name = name;
      return this.namecell.textContent = this.name;
    };

    PointWidget.prototype.set_color = function(color) {
      PointWidget.__super__.set_color.call(this, color);
      if (this.color_selector_el != null) {
        return this.color_selector_el.value = this.color;
      }
    };

    PointWidget.prototype.on_color_change = function(event) {
      this.set_color(event.target.value);
      return APP.resumable_reset();
    };

    PointWidget.prototype.on_move_per_range_input = function(event) {
      this.set_move_perc(event.target.value);
      return APP.resumable_reset();
    };

    PointWidget.prototype.set_move_perc = function(newvalue) {
      this.move_perc = parseFloat(newvalue);
      if (this.move_perc_cell) {
        return this.move_perc_cell.textContent = this.move_perc.toFixed(2);
      }
    };

    PointWidget.prototype.highlight = function() {
      var oldval;
      this.row.classList.add('highlight');
      oldval = this.draw_highlight;
      this.draw_highlight = true;
      return oldval !== this.draw_highlight;
    };

    PointWidget.prototype.unhighlight = function() {
      var oldval;
      this.row.classList.remove('highlight');
      oldval = this.draw_highlight;
      this.draw_highlight = false;
      return oldval !== this.draw_highlight;
    };

    PointWidget.prototype.draw_ui = function() {
      var ctx;
      if (this.draw_highlight) {
        ctx = APP.graph_ui_ctx;
        ctx.save();
        ctx.strokeStyle = '#F97570';
        ctx.fillStyle = '#FEFFC6';
        ctx.setLineDash([4]);
        ctx.beginPath();
        ctx.arc(this.x, this.y, 15, 0, Math.TAU, false);
        ctx.fill();
        ctx.stroke();
        ctx.restore();
      }
      return PointWidget.__super__.draw_ui.apply(this, arguments);
    };

    PointWidget.prototype.save = function() {
      var opt;
      return opt = {
        name: this.name,
        x: this.x,
        y: this.y,
        move_perc: this.move_perc,
        color: this.color
      };
    };

    PointWidget.prototype.load = function(opt) {
      if (opt.name != null) {
        this.set_name(opt.name);
      }
      if ((opt.x != null) && (opt.y != null)) {
        this.move(opt.x, opt.y);
      }
      if (opt.move_perc != null) {
        this.set_move_perc(opt.move_perc);
      }
      if (opt.color != null) {
        this.set_color(opt.color);
      }
      return APP.resumable_reset();
    };

    PointWidget.prototype.destroy = function() {
      var idx;
      idx = PointWidget.widgets.indexOf(this);
      if (idx > -1) {
        PointWidget.widgets.splice(idx, 1);
        PointWidget.update_widget_list_metadata();
      }
      this.color_selector_el.remove();
      this.move_per_range_el.remove();
      this.row.remove();
      return APP.resumable_reset();
    };

    return PointWidget;

  })(UIPoint);

  DrawPoint = (function(superClass) {
    extend(DrawPoint, superClass);

    function DrawPoint(name, draw_style) {
      DrawPoint.__super__.constructor.call(this, '0', name);
      this.info_x = APP.context.getElementById(this.info_x_id);
      this.info_y = APP.context.getElementById(this.info_y_id);
      this.set_color('#000000');
      this.set_draw_style(draw_style);
    }

    DrawPoint.prototype.reset_color_cache = function() {
      this.color_avg = {};
      return this.prev_color_blend = Color.hexrgb_to_rgb(this.color);
    };

    DrawPoint.prototype.blend_target_colors = function(a, b) {
      var a_rgb, b_rgb, blend;
      a_rgb = Color.hexrgb_to_rgb(a.color);
      b_rgb = Color.hexrgb_to_rgb(b.color);
      blend = Color.blend_rgb(a_rgb, b_rgb);
      return "rgba(" + blend[0] + "," + blend[1] + "," + blend[2] + "," + this.alpha + ")";
    };

    DrawPoint.prototype.get_color_mono = function() {
      return this.color_alpha;
    };

    DrawPoint.prototype.get_color_target = function(target) {
      return target.color_alpha;
    };

    DrawPoint.prototype.get_color_blend_prev1 = function() {
      var a, b, base1, name;
      b = PointWidget.prev_target[1];
      a = PointWidget.prev_target[0];
      if (b == null) {
        return a.color_alpha;
      }
      name = a.name + b.name;
      return (base1 = this.color_avg)[name] != null ? base1[name] : base1[name] = this.blend_target_colors(a, b);
    };

    DrawPoint.prototype.get_color_blend_prev2 = function(target) {
      var c, p, t;
      t = Color.hexrgb_to_rgb(target.color);
      p = this.prev_color_blend;
      this.prev_color_blend = Color.blend_rgb(t, p);
      c = "rgba(" + this.prev_color_blend[0] + "," + this.prev_color_blend[1] + "," + this.prev_color_blend[2] + "," + this.alpha + ")";
      return c;
    };

    DrawPoint.prototype.set_draw_style = function(mode) {
      return this.get_current_color = (function() {
        switch (mode) {
          case 'mono':
            return this.get_color_mono;
          case 'color_target':
            return this.get_color_target;
          case 'color_blend_prev_target':
            return this.get_color_blend_prev1;
          case 'color_blend_prev_color':
            return this.get_color_blend_prev2;
          default:
            return this.get_color_mono;
        }
      }).call(this);
    };

    DrawPoint.prototype.set_opacity = function(opacity) {
      this.opacity = opacity;
      this.alpha = opacity / 100;
      return DrawPoint.__super__.set_opacity.call(this, opacity);
    };

    DrawPoint.prototype.draw_graph = function(target) {
      var ctx;
      ctx = APP.graph_ctx;
      ctx.fillStyle = this.get_current_color(target);
      return ctx.fillRect(this.x, this.y, 1, 1);
    };

    return DrawPoint;

  })(UIPoint);

  TargetRestrictionOption = (function() {
    function TargetRestrictionOption(context, offset, name1) {
      var double_selector, selector, single_selector;
      this.context = context;
      this.offset = offset;
      this.name = name1;
      this.on_change_double = bind(this.on_change_double, this);
      this.on_change_single = bind(this.on_change_single, this);
      selector = "#restrict_table ." + this.name;
      this.column_cells = this.context.querySelectorAll(selector);
      single_selector = selector + ".single input[type=\"checkbox\"]";
      double_selector = selector + ".double input[type=\"checkbox\"]";
      this.checkbox_single = this.context.querySelector(single_selector);
      this.checkbox_double = this.context.querySelector(double_selector);
      this.reset();
      this.checkbox_single.addEventListener('change', this.on_change_single);
      this.checkbox_double.addEventListener('change', this.on_change_double);
    }

    TargetRestrictionOption.prototype.reset = function() {
      this.set_single(false);
      return this.set_double(false);
    };

    TargetRestrictionOption.prototype.set_column_cells = function(state) {
      var cell, j, len1, ref, results;
      ref = this.column_cells;
      results = [];
      for (j = 0, len1 = ref.length; j < len1; j++) {
        cell = ref[j];
        results.push(cell.style.display = state);
      }
      return results;
    };

    TargetRestrictionOption.prototype.enable = function() {
      this.enabled = true;
      return this.set_column_cells('table-cell');
    };

    TargetRestrictionOption.prototype.disable = function() {
      this.enabled = false;
      return this.set_column_cells('none');
    };

    TargetRestrictionOption.prototype.set_single = function(value) {
      this.value_single = value;
      this.checkbox_single.checked = this.value_single;
      PointWidget.update_widget_list_metadata();
      return APP.resumable_reset();
    };

    TargetRestrictionOption.prototype.set_double = function(value) {
      this.value_double = value;
      this.checkbox_double.checked = this.value_double;
      PointWidget.update_widget_list_metadata();
      return APP.resumable_reset();
    };

    TargetRestrictionOption.prototype.on_change_single = function(event) {
      return this.set_single(event.target.checked);
    };

    TargetRestrictionOption.prototype.on_change_double = function(event) {
      return this.set_double(event.target.checked);
    };

    return TargetRestrictionOption;

  })();

  TargetRestriction = (function() {
    function TargetRestriction(context) {
      var j, len1, o, ref;
      this.context = context;
      this.option = {
        prev: [new TargetRestrictionOption(this.context, -1, 'prev1'), new TargetRestrictionOption(this.context, -2, 'prev2'), new TargetRestrictionOption(this.context, -3, 'prev3')],
        self: new TargetRestrictionOption(this.context, 0, 'self'),
        next: [new TargetRestrictionOption(this.context, 1, 'next1'), new TargetRestrictionOption(this.context, 2, 'next2'), new TargetRestrictionOption(this.context, 3, 'next3')],
        opposite: new TargetRestrictionOption(this.context, 4, 'opposite')
      };
      this.options = Object.values(this.option).flatten();
      this.by_name = {};
      ref = this.options;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        o = ref[j];
        this.by_name[o.name] = o;
      }
    }

    TargetRestriction.prototype.find = function(name) {
      if (this.by_name[name] != null) {
        return this.by_name[name];
      } else {
        console.log("no such restriction named '" + name + "'");
        return null;
      }
    };

    TargetRestriction.prototype.set_enabled = function(n) {
      var j, len1, neighbor, next, o, prev, ref, ref1;
      ref = this.options;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        o = ref[j];
        o.disable();
      }
      this.option.self.enable();
      n -= 1;
      if (n % 2 === 1) {
        this.option.opposite.enable();
        n -= 1;
      }
      neighbor = 1;
      while (n >= 2) {
        ref1 = this.neighbor(neighbor), prev = ref1[0], next = ref1[1];
        prev.enable();
        next.enable();
        n -= 2;
        neighbor += 1;
      }
      return null;
    };

    TargetRestriction.prototype.using_double = function() {
      var j, len1, o, ref;
      ref = this.options;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        o = ref[j];
        if (o.enabled && o.value_double) {
          return true;
        }
      }
      return false;
    };

    TargetRestriction.prototype.restricted_single = function() {
      return this.options.filter(function(o) {
        return o.value_single;
      });
    };

    TargetRestriction.prototype.restricted_double = function() {
      return this.options.filter(function(o) {
        return o.value_double;
      });
    };

    TargetRestriction.prototype.neighbor = function(n) {
      return [this.by_name["prev" + n], this.by_name["next" + n]];
    };

    TargetRestriction.prototype.save = function() {
      var opt;
      return opt = {
        single: this.restricted_single().map(function(x) {
          return x.name;
        }),
        double: this.restricted_double().map(function(x) {
          return x.name;
        })
      };
    };

    TargetRestriction.prototype.load = function(opt) {
      var j, k, len1, len2, len3, m, name, o, ref, ref1, ref2, ref3;
      for (j = 0, len1 = opt.length; j < len1; j++) {
        o = opt[j];
        o.reset();
      }
      if (opt.single != null) {
        ref = opt.single;
        for (k = 0, len2 = ref.length; k < len2; k++) {
          name = ref[k];
          if ((ref1 = this.find(name)) != null) {
            ref1.set_single(true);
          }
        }
      }
      if (opt.double != null) {
        ref2 = opt.double;
        for (m = 0, len3 = ref2.length; m < len3; m++) {
          name = ref2[m];
          if ((ref3 = this.find(name)) != null) {
            ref3.set_double(true);
          }
        }
      }
      PointWidget.update_widget_list_metadata();
      return APP.resumable_reset();
    };

    return TargetRestriction;

  })();

  OtherOption = (function() {
    function OtherOption(context, id, _default, on_change_callback) {
      this.context = context;
      this.id = id;
      this["default"] = _default;
      this.on_change_callback = on_change_callback != null ? on_change_callback : null;
      this.on_change = bind(this.on_change, this);
      this.el = this.context.getElementById(this.id);
      this.set(this["default"]);
      this.el.addEventListener('change', this.on_change);
    }

    OtherOption.prototype.on_change = function(event) {
      this.set(this.get(event.target));
      if (this.on_change_callback != null) {
        return this.on_change_callback(this.value);
      }
    };

    return OtherOption;

  })();

  BoolOtherOption = (function(superClass) {
    extend(BoolOtherOption, superClass);

    function BoolOtherOption() {
      return BoolOtherOption.__super__.constructor.apply(this, arguments);
    }

    BoolOtherOption.prototype.get = function(element) {
      if (element == null) {
        element = this.el;
      }
      return element.checked;
    };

    BoolOtherOption.prototype.set = function(bool_value) {
      this.value = !!bool_value;
      return this.el.checked = this.value;
    };

    return BoolOtherOption;

  })(OtherOption);

  NumberOtherOption = (function(superClass) {
    extend(NumberOtherOption, superClass);

    function NumberOtherOption() {
      return NumberOtherOption.__super__.constructor.apply(this, arguments);
    }

    NumberOtherOption.prototype.get = function(element) {
      if (element == null) {
        element = this.el;
      }
      return element.value;
    };

    NumberOtherOption.prototype.set = function(number_value) {
      this.value = parseInt(number_value);
      return this.el.value = this.value;
    };

    return NumberOtherOption;

  })(OtherOption);

  EnumOtherOption = (function(superClass) {
    extend(EnumOtherOption, superClass);

    function EnumOtherOption() {
      return EnumOtherOption.__super__.constructor.apply(this, arguments);
    }

    EnumOtherOption.prototype.get = function(element) {
      if (element == null) {
        element = this.el;
      }
      return element.value;
    };

    EnumOtherOption.prototype.find_option_by_value = function(enum_value) {
      var j, len1, opt, ref;
      ref = this.el.options;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        opt = ref[j];
        if (opt.value === enum_value) {
          return opt;
        }
      }
      return null;
    };

    EnumOtherOption.prototype.set = function(enum_value) {
      var opt;
      opt = this.find_option_by_value(enum_value);
      if (opt != null) {
        this.el.value = opt.value;
      }
      return this.value = this.el.value;
    };

    return EnumOtherOption;

  })(OtherOption);

  StochasticSierpinski = (function() {
    function StochasticSierpinski(context) {
      this.context = context;
      this.on_keydown = bind(this.on_keydown, this);
      this.update = bind(this.update, this);
      this.redraw_ui = bind(this.redraw_ui, this);
      this.step = bind(this.step, this);
      this.stop = bind(this.stop, this);
      this.start = bind(this.start, this);
      this.on_run = bind(this.on_run, this);
      this.on_multistep = bind(this.on_multistep, this);
      this.on_step = bind(this.on_step, this);
      this.on_reset = bind(this.on_reset, this);
      this.resumable_reset = bind(this.resumable_reset, this);
      this.on_mousemove = bind(this.on_mousemove, this);
      this.on_mouseup = bind(this.on_mouseup, this);
      this.on_mousedown = bind(this.on_mousedown, this);
      this.max_xy = bind(this.max_xy, this);
      this.random_y = bind(this.random_y, this);
      this.random_x = bind(this.random_x, this);
      this.on_move_all_random = bind(this.on_move_all_random, this);
      this.on_move_all_reg_polygon = bind(this.on_move_all_reg_polygon, this);
      this.on_save_url = bind(this.on_save_url, this);
      this.on_load = bind(this.on_load, this);
      this.on_save = bind(this.on_save, this);
      this.deserialize = bind(this.deserialize, this);
      this.on_serializebox_cancel = bind(this.on_serializebox_cancel, this);
      this.on_serializebox_action = bind(this.on_serializebox_action, this);
      this.on_create_png = bind(this.on_create_png, this);
      this.on_steps_per_frame_input = bind(this.on_steps_per_frame_input, this);
      this.on_num_points_input = bind(this.on_num_points_input, this);
      this.on_canvas_hw_change = bind(this.on_canvas_hw_change, this);
      this.on_graph_wrapper_mutate = bind(this.on_graph_wrapper_mutate, this);
      this.on_mouseleave = bind(this.on_mouseleave, this);
      this.on_mouseenter = bind(this.on_mouseenter, this);
      this.on_draw_opacity_change = bind(this.on_draw_opacity_change, this);
      this.on_draw_style_change = bind(this.on_draw_style_change, this);
    }

    StochasticSierpinski.prototype.init = function() {
      var i, j, k, r, ref, ref1, s;
      this.running = false;
      this.step_count = 0;
      this.steps_per_frame_el = this.context.getElementById('steps_per_frame');
      this.graph_wrapper = this.context.getElementById('graph_wrapper');
      this.graph_canvas = this.context.getElementById('graph');
      this.graph_ui_canvas = this.context.getElementById('graph_ui');
      this.graph_ctx = this.graph_canvas.getContext('2d', {
        alpha: true
      });
      this.graph_ui_ctx = this.graph_ui_canvas.getContext('2d', {
        alpha: true
      });
      this.btn_reset = this.context.getElementById('button_reset');
      this.btn_step = this.context.getElementById('button_step');
      this.btn_multistep = this.context.getElementById('button_multistep');
      this.btn_run = this.context.getElementById('button_run');
      this.btn_create_png = this.context.getElementById('button_create_png');
      this.btn_save_url = this.context.getElementById('button_save_url');
      this.btn_save = this.context.getElementById('button_save');
      this.btn_load = this.context.getElementById('button_load');
      this.total_steps_cell = this.context.getElementById('total_steps');
      this.point_pos_table = this.context.getElementById('point_pos_table');
      this.btn_move_all_reg_polygon = this.context.getElementById('move_all_reg_polygon');
      this.btn_move_all_random = this.context.getElementById('move_all_random');
      this.option = {
        canvas_width: new NumberOtherOption(this.context, 'canvas_width', 420, this.on_canvas_hw_change),
        canvas_height: new NumberOtherOption(this.context, 'canvas_height', 320, this.on_canvas_hw_change),
        draw_style: new EnumOtherOption(this.context, 'draw_style', 'color_blend_prev_color', this.on_draw_style_change),
        draw_opacity: new NumberOtherOption(this.context, 'draw_opacity', 35, this.on_draw_opacity_change)
      };
      this.serializebox = this.context.getElementById('serializebox');
      this.serializebox_title = this.context.getElementById('serializebox_title');
      this.serializebox_text = this.context.getElementById('serializebox_text');
      this.serializebox_action = this.context.getElementById('serializebox_action');
      this.serializebox_cancel = this.context.getElementById('serializebox_cancel');
      PointWidget.restrictions = new TargetRestriction(this.context);
      this.cur = new DrawPoint('Cur', this.option.draw_style.value);
      PointWidget.set_ngon(3);
      this.set_steps_per_frame(100);
      this.num_points_el = this.context.getElementById('num_points');
      this.num_points_el.value = PointWidget.widgets.length;
      this.num_points_el.addEventListener('input', this.on_num_points_input);
      this.steps_per_frame_el.addEventListener('input', this.on_steps_per_frame_input);
      this.btn_reset.addEventListener('click', this.on_reset);
      this.btn_step.addEventListener('click', this.on_ste);
      this.btn_multistep.addEventListener('click', this.on_multistep);
      this.btn_run.addEventListener('click', this.on_run);
      this.context.addEventListener('keydown', this.on_keydown);
      this.btn_create_png.addEventListener('click', this.on_create_png);
      this.btn_save_url.addEventListener('click', this.on_save_url);
      this.btn_save.addEventListener('click', this.on_save);
      this.btn_load.addEventListener('click', this.on_load);
      this.btn_move_all_reg_polygon.addEventListener('click', this.on_move_all_reg_polygon);
      this.btn_move_all_random.addEventListener('click', this.on_move_all_random);
      this.serializebox_action.addEventListener('click', this.on_serializebox_action);
      this.serializebox_cancel.addEventListener('click', this.on_serializebox_cancel);
      this.graph_ui_canvas.addEventListener('mousedown', this.on_mousedown);
      this.graph_ui_canvas.addEventListener('mouseup', this.on_mouseup);
      this.graph_ui_canvas.addEventListener('mousemove', this.on_mousemove);
      this.graph_wrapper.addEventListener('mouseenter', this.on_mouseenter);
      this.graph_wrapper.addEventListener('mouseleave', this.on_mouseleave);
      for (i = j = 0, ref = document.styleSheets.length; 0 <= ref ? j <= ref : j >= ref; i = 0 <= ref ? ++j : --j) {
        s = document.styleSheets[i];
        if ((s != null ? s.title : void 0) === 'app_stylesheet') {
          this.app_stylesheet = s;
          break;
        }
      }
      if (this.app_stylesheet != null) {
        for (i = k = 0, ref1 = this.app_stylesheet.cssRules.length; 0 <= ref1 ? k <= ref1 : k >= ref1; i = 0 <= ref1 ? ++k : --k) {
          r = this.app_stylesheet.cssRules[i];
          if ((r != null ? r.selectorText : void 0) === '.canvas_size') {
            this.canvas_size_rule = r;
            break;
          }
        }
        if (this.canvas_size_rule != null) {
          this.graph_wrapper_observer = new MutationObserver(this.on_graph_wrapper_mutate);
          this.graph_wrapper_observer.observe(this.graph_wrapper, {
            attributes: true
          });
        }
      }
      return this.clear_update_and_draw();
    };

    StochasticSierpinski.prototype.on_draw_style_change = function() {
      return this.cur.set_draw_style(this.option.draw_style.value);
    };

    StochasticSierpinski.prototype.on_draw_opacity_change = function() {
      var j, len1, o, ref, results, w;
      o = this.option.draw_opacity.value;
      this.cur.set_opacity(o);
      ref = PointWidget.widgets;
      results = [];
      for (j = 0, len1 = ref.length; j < len1; j++) {
        w = ref[j];
        results.push(w.set_opacity(o));
      }
      return results;
    };

    StochasticSierpinski.prototype.clear_update_and_draw = function() {
      this.update_info_elements();
      this.clear_graph_canvas();
      return this.redraw_ui();
    };

    StochasticSierpinski.prototype.on_mouseenter = function() {
      return this.graph_wrapper.classList.add('resizable');
    };

    StochasticSierpinski.prototype.on_mouseleave = function() {
      return this.graph_wrapper.classList.remove('resizable');
    };

    StochasticSierpinski.prototype.on_graph_wrapper_mutate = function(event) {
      if (this.graph_wrapper.offsetWidth !== this.graph_ui_canvas.width || this.graph_wrapper.offsetHeight !== this.graph_ui_canvas.height) {
        return this.resize_graph(this.graph_wrapper.offsetWidth, this.graph_wrapper.offsetHeight);
      }
    };

    StochasticSierpinski.prototype.resize_graph = function(w, h) {
      this.graph_canvas.width = w;
      this.graph_canvas.height = h;
      this.graph_ui_canvas.width = w;
      this.graph_ui_canvas.height = h;
      this.canvas_size_rule.style.width = w + "px";
      this.canvas_size_rule.style.height = h + "px";
      this.option.canvas_width.set(w);
      this.option.canvas_height.set(h);
      PointWidget.clamp_widgets_to_canvas();
      return this.resumable_reset();
    };

    StochasticSierpinski.prototype.on_canvas_hw_change = function() {
      return this.resize_graph(this.option.canvas_width.value, this.option.canvas_height.value);
    };

    StochasticSierpinski.prototype.on_num_points_input = function(event) {
      return PointWidget.set_ngon(event.target.value);
    };

    StochasticSierpinski.prototype.on_steps_per_frame_input = function(event) {
      return this.set_steps_per_frame(event.target.value);
    };

    StochasticSierpinski.prototype.set_steps_per_frame = function(int_value) {
      this.steps_per_frame = parseInt(int_value);
      if (this.steps_per_frame < 1) {
        this.steps_per_frame = 1;
      }
      this.btn_multistep.textContent = "Step " + this.steps_per_frame + "x";
      if (this.steps_per_frame === 1) {
        this.steps_per_frame_el.value = 0;
        return this.btn_multistep.disabled = true;
      } else {
        this.steps_per_frame_el.value = this.steps_per_frame;
        return this.btn_multistep.disabled = false;
      }
    };

    StochasticSierpinski.prototype.on_create_png = function() {
      var dataurl;
      dataurl = this.graph_canvas.toDataURL('png');
      return window.open(dataurl, '_blank');
    };

    StochasticSierpinski.prototype.show_serializebox = function(title, text, action_callback) {
      this.serializebox_title.textContent = title;
      this.serializebox_action.textContent = title;
      if (text != null) {
        this.serializebox_text.value = text;
      } else {
        this.serializebox_text.value = '';
      }
      if (action_callback != null) {
        this.serializebox_action.style.display = 'inline-block';
        this.serializebox_action_callback = action_callback;
        this.serializebox_cancel.textContent = 'Cancel';
      } else {
        this.serializebox_action.style.display = 'none';
        this.serializebox_cancel.textContent = 'Close';
      }
      return this.serializebox.style.display = 'block';
    };

    StochasticSierpinski.prototype.hide_serializebox = function() {
      return this.serializebox.style.display = 'none';
    };

    StochasticSierpinski.prototype.on_serializebox_action = function() {
      if (this.serializebox_action_callback != null) {
        this.serializebox_action_callback(this.serializebox_text.value);
      }
      return this.hide_serializebox();
    };

    StochasticSierpinski.prototype.on_serializebox_cancel = function() {
      return this.hide_serializebox();
    };

    StochasticSierpinski.prototype.serialize = function() {
      var opt;
      opt = {
        points: PointWidget.widgets.map(function(x) {
          return x.save();
        }),
        restrictions: PointWidget.restrictions.save(),
        options: {
          canvas_width: this.option.canvas_width.value,
          canvas_height: this.option.canvas_height.value,
          draw_style: this.option.draw_style.value,
          draw_opacity: this.option.draw_opacity.value
        }
      };
      return JSON.stringify(opt);
    };

    StochasticSierpinski.prototype.deserialize = function(text) {
      var i, j, len1, opt, p, ref;
      opt = JSON.parse(text);
      if (opt.options != null) {
        if ((opt.options.canvas_width != null) && (opt.options.canvas_width != null)) {
          this.resize_graph(opt.options.canvas_width, opt.options.canvas_width);
        }
        if (opt.options.draw_style != null) {
          this.option.draw_style.set(opt.options.draw_style);
        }
        if (opt.options.draw_opacity != null) {
          this.option.draw_opacity.set(opt.options.draw_opacity);
        }
      }
      if (opt.points != null) {
        this.num_points_el.valueAsNumber = PointWidget.widgets.length;
        PointWidget.set_num_widgets(opt.points.length);
        ref = opt.points;
        for (i = j = 0, len1 = ref.length; j < len1; i = ++j) {
          p = ref[i];
          PointWidget.widgets[i].load(p);
        }
      }
      if (opt.restrictions != null) {
        return PointWidget.restrictions.load(opt.restrictions);
      }
    };

    StochasticSierpinski.prototype.on_save = function() {
      return this.show_serializebox('Save', this.serialize(), null);
    };

    StochasticSierpinski.prototype.on_load = function() {
      return this.show_serializebox('Load', null, this.deserialize);
    };

    StochasticSierpinski.prototype.on_save_url = function() {
      var hash;
      hash = this.serialize();
      return document.location = "#" + hash;
    };

    StochasticSierpinski.prototype.on_move_all_reg_polygon = function() {
      return PointWidget.move_all_reg_polygon();
    };

    StochasticSierpinski.prototype.on_move_all_random = function() {
      return PointWidget.move_all_random();
    };

    StochasticSierpinski.prototype.random_x = function() {
      return parseInt(Math.random() * this.graph_ui_canvas.width);
    };

    StochasticSierpinski.prototype.random_y = function() {
      return parseInt(Math.random() * this.graph_ui_canvas.height);
    };

    StochasticSierpinski.prototype.max_xy = function() {
      return [this.graph_ui_canvas.width, this.graph_ui_canvas.height];
    };

    StochasticSierpinski.prototype.update_info_elements = function() {
      var ref;
      this.total_steps_cell.textContent = this.step_count;
      return (ref = this.cur) != null ? ref.update_text() : void 0;
    };

    StochasticSierpinski.prototype.event_to_canvas_loc = function(event) {
      return {
        x: event.layerX,
        y: event.layerY
      };
    };

    StochasticSierpinski.prototype.is_inside_ui = function(loc) {
      var ref, ref1;
      return ((0 <= (ref = loc.x) && ref <= this.graph_ui_canvas.width)) && ((0 <= (ref1 = loc.y) && ref1 <= this.graph_ui_canvas.height));
    };

    StochasticSierpinski.prototype.on_mousedown = function(event) {
      var loc, w;
      PointWidget.unhighlight_all();
      loc = this.event_to_canvas_loc(event);
      w = PointWidget.first_nearby_widget(loc);
      if (w != null) {
        this.dnd_target = w;
        return w.highlight();
      }
    };

    StochasticSierpinski.prototype.on_mouseup = function(event) {
      var loc;
      if (this.dnd_target != null) {
        loc = this.event_to_canvas_loc(event);
        if (this.is_inside_ui(loc)) {
          this.dnd_target.move(loc.x, loc.y);
          this.redraw_ui();
          this.resumable_reset();
        }
        return this.dnd_target = null;
      }
    };

    StochasticSierpinski.prototype.on_mousemove = function(event) {
      var loc, redraw, w;
      loc = this.event_to_canvas_loc(event);
      if (this.dnd_target != null) {
        if (this.is_inside_ui(loc)) {
          this.dnd_target.move(loc.x, loc.y);
          this.redraw_ui();
          return this.resumable_reset();
        }
      } else {
        redraw = PointWidget.unhighlight_all();
        w = PointWidget.first_nearby_widget(loc);
        if (w != null) {
          if (w.highlight()) {
            redraw = true;
          }
        }
        if (redraw) {
          return this.redraw_ui();
        }
      }
    };

    StochasticSierpinski.prototype.resumable_reset = function() {
      return this.on_reset(true);
    };

    StochasticSierpinski.prototype.clear_graph_canvas = function() {
      this.graph_ctx.clearRect(0, 0, this.graph_canvas.width, this.graph_canvas.height);
      this.graph_ctx.fillStyle = '#fff';
      return this.graph_ctx.fillRect(0, 0, this.graph_canvas.width, this.graph_canvas.height);
    };

    StochasticSierpinski.prototype.on_reset = function(restart_ok) {
      var was_running;
      if (restart_ok == null) {
        restart_ok = false;
      }
      was_running = this.running;
      this.stop();
      if (this.cur != null) {
        this.cur.move(this.graph_ui_canvas.width / 2, this.graph_ui_canvas.height / 2);
        this.cur.reset_color_cache();
      }
      this.step_count = 0;
      this.clear_update_and_draw();
      if (restart_ok && was_running) {
        return this.start();
      }
    };

    StochasticSierpinski.prototype.on_step = function() {
      if (this.running) {
        return this.stop();
      } else {
        return this.step();
      }
    };

    StochasticSierpinski.prototype.on_multistep = function() {
      if (this.running) {
        return this.stop();
      } else {
        return this.multistep();
      }
    };

    StochasticSierpinski.prototype.on_run = function() {
      if (this.running) {
        return this.stop();
      } else {
        return this.start();
      }
    };

    StochasticSierpinski.prototype.start = function() {
      this.running = true;
      this.btn_run.textContent = 'Pause';
      this.btn_run.classList.remove('paused');
      this.btn_run.classList.add('running');
      return this.schedule_next_frame();
    };

    StochasticSierpinski.prototype.stop = function() {
      this.running = false;
      this.btn_run.textContent = 'Run';
      this.btn_run.classList.remove('running');
      return this.btn_run.classList.add('paused');
    };

    StochasticSierpinski.prototype.single_step = function() {
      var target;
      target = PointWidget.random_widget();
      if (target != null) {
        this.cur.move_towards_no_text_update(target);
        this.cur.draw_graph(target);
        return this.step_count += 1;
      }
    };

    StochasticSierpinski.prototype.step = function(num_steps) {
      var j, ref;
      if (num_steps == null) {
        num_steps = 1;
      }
      for (j = 0, ref = num_steps; 0 <= ref ? j < ref : j > ref; 0 <= ref ? j++ : j--) {
        this.single_step();
      }
      this.update_info_elements();
      return this.redraw_ui();
    };

    StochasticSierpinski.prototype.multistep = function() {
      return this.step(this.steps_per_frame);
    };

    StochasticSierpinski.prototype.redraw_ui = function() {
      var j, len1, p, ref, ref1, results;
      this.graph_ui_ctx.clearRect(0, 0, this.graph_ui_canvas.width, this.graph_ui_canvas.height);
      if ((ref = this.cur) != null) {
        ref.draw_ui();
      }
      ref1 = PointWidget.widgets;
      results = [];
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        p = ref1[j];
        results.push(p.draw_ui());
      }
      return results;
    };

    StochasticSierpinski.prototype.update = function() {
      this.frame_is_scheduled = false;
      this.multistep();
      if (this.running) {
        return this.schedule_next_frame();
      }
    };

    StochasticSierpinski.prototype.schedule_next_frame = function() {
      if (!this.frame_is_scheduled) {
        this.frame_is_scheduled = true;
        return window.requestAnimationFrame(this.update);
      }
    };

    StochasticSierpinski.prototype.on_keydown = function(event) {
      switch (event.key) {
        case "Enter":
          return this.on_run();
        case "Escape":
        case "Esc":
          return this.stop();
        case "r":
        case "R":
          return this.resumable_reset();
        case "p":
        case "P":
          return this.on_create_png();
        case "s":
        case "S":
          return this.on_save();
        case "l":
        case "L":
          return this.on_load();
      }
    };

    return StochasticSierpinski;

  })();

  document.addEventListener('DOMContentLoaded', (function(_this) {
    return function() {
      var ref;
      APP = new StochasticSierpinski(document);
      APP.init();
      if (((ref = document.location.hash) != null ? ref.length : void 0) > 1) {
        return APP.deserialize(document.location.hash.slice(1));
      }
    };
  })(this));

}).call(this);

    </script>
  </body>
</html>
